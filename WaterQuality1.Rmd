---
title: "Exploring water quality"
author: "Nicolas F. S-Gelais"
date: '`r Sys.Date()`'
output: 
  word_document:
    fig_width: 5
    fig_height: 5
    fig_caption: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='figures/',
                      echo=TRUE, warning=FALSE, message=FALSE,fig.width=6, fig.height=6,fig.align = "center")

knitr::opts_knit$set(output.dir="reports")
```

###Introduction


```{r init data,echo=F}

#Import the canadian rivers dataset data on stations and the canadian guidelines

library(knitr)
library(kableExtra)
library(ReporteRs)
library(maps)
library(fmsb)
library(dplyr)
library(ggplot2)
library(tidyr)
#library(png) 
rm(list=ls(all=TRUE))
source("R/functions.R")
source("R/critByGroup.R")
source("R/overlapES.R")

load("data/dataCDN.RData")
load("data/sitesClass.RData")
load("data/critLim.RData")
colFreq<-function(x)sum(!is.na(x))/length(x)
input =read.csv("inputs/dbInput_cdnRiv.csv",na.strings = "",stringsAsFactors = T)


```


### Approach and framework

*Creating a common guideline database*

We created a common guidelines database (*link to the Db*) composed of Canadian guidelines that are used to determine if water can safely provide the following uses: drinking water, recreation (i.e. swimming), irrigation, livestock water and for the protection of aquatic wildlife, which are toxicological guidelines aiming  for the protection of  the most sensitive life stage and species (CCME). *Few guidelines were under the present detection limit for a specific compounds, in those situations we used as a guideline the detection limit multiplied by 2*. For trophic status, we used Dodd 1998 river trophic status classification. In total, the guidelines are based on  `r length(unique(guide$Pollutant))` different chemical compounds. 
We grouped the guidelines by chemical groups (based on the CCME classification) to assess the amount of overlap between the guidelines used for each ecosystem services. To do so, for each ES, we calculated thte proportion of guidelines used in each chemical group (See Table 1). Following this step, in each chemical group, we selected compounds that we used as guidelines for the highest number of ES for further analyses (see categories table). 


*Creating an aggregated limnological database*

We wrote a R script (*dbExtract*) to search openly available canadian limnological databases for measures of the selected compounds in rivers. The seach within databases resulted in 660 000 unique observation of the selected coumpounds in river across Canada between 1995-2017. Observation, were then grouped by station and by month (*dbSpread* function) to create a aggregated limnological database of `r nrow(db_wide_ym)` observations. 

Then we wrote the function ESeval() which evaluate the potential of providing the seleted ES at each sampling event (by month and by station) based on the common guideline db and the aggregated limnological DB. The is an important variability in the variables measured at each sampling event, so the potential of providing a gien ES was based on the guidelines for which a measure was available, and when no varaibles measures enable to evaluate whetehr a service could be provided, the service wasn't evaluated for this specific sampling event.  Then we compared the overlap between ES services by computing how often the often services are avaialble when a specific service is available. 

THis function uses the ES space DB to calculate the emperical overlap between ecosystem services in canadian rivers.

*Identify which guidelines is limiting use across sites*

For each ES we identified how often a specific compound is limiting use across all sampling event. To do we we wrote a function limFreq(), which based on the ES space DB and the Aggregated limnological DB calculate how often when a compounds is measured this compound limit the avalability of a given SE. 

 For each guideline, we report how often when a sample cannot provide an ecoservice a specific guideline responsible for the none compliance. 



Table 1: The proportion of guidelines in each chemical group by ecosystem services (ES) based on Canadian guidelines and


```{r Explore guidelines ,echo=F}

# explore the frequency of each guideline
polFreq=matrix(NA,length(unique(guide$Pollutant)),2,dimnames=list(unique(guide$Pollutant),c("Group","Freq")))

i="fc"
#for(i in rownames(polFreq)){
#  polFreq[i,"Freq"]=length(unique(guide[guide$Pollutant%in%i,"SuperCategory"]))
#  polFreq[i,"Group"]=unique(guide[guide$Pollutant%in%i,"Chemical.groups"])
#}



# This function calculates the proportion of guidelines by chemical groups for each ES. Output is a table 
polCat=critByGroup(guide$Chemical.groups,guide$SuperCategory)

# modify the table to only output the desired ES and chemical groups. 
remove.cols=c("Disinfectant & BP","Physical","pH","DOC")
remove.rows=c("DOC")
polCat.mod=round(polCat[ !rownames(polCat) %in% remove.rows,  !colnames(polCat) %in% remove.cols],2)

#Order rows and columns
polCat.mod=polCat.mod[,order(colnames(polCat.mod))]
polCat.mod=polCat.mod[order(rownames(polCat.mod)),order(colnames(polCat.mod))]
rownames(polCat.mod)=c("Aquatic Wildlife","Drinking","Irrigation","Livestock","Recreational","Trophic Status")

# Change col names
polCat.mod=data.frame(ES=rownames(polCat.mod),polCat.mod)
colnames(polCat.mod)=c("Ecosystem Services","Biological","Inorganic chemicals","Metals","Nutrients","Organic chemicals","Pesticides")

write.csv(polCat.mod,"data/polCat.mod.csv")

# create output table 
polCat.mod %>%
  mutate_if(is.numeric, function(x) {
    cell_spec(x, "html", bold = T, color = "white",
              background  = spec_color(x, begin=1,end = 0.6,option="A"))
  }) %>%
kable(polCat ,escape = F,format = "pandoc", align = "c") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, angle = 0)

 # ReporteRsWrap(plotHeatMap,"HeatMap")

#kable(incMatrix, "html") %>%
 # kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

We  observed on important overlap between the guidelines  established by the CCME for Aquatic wildlife, Drinking, Irrigation and Livestock. The guidelines for these uses and in large proportion based on the concentration metals, pesticides and other organics coumpounds. This important overlap is the results that to sutability for these uses is based on eco-toxological studies on living organisms. Most of these guidelines are from lab experiments or epidemilogic studies for human (to verify). In opposition, the guidelines for recreation (in this case swimming) is mainly based on biological guidelines (E.coli and microsystin) and on pH and water temperature (not shown in this table) the guidelines for swimming are established by a X entity. It is intereting that guidelines for swimming are so different than guidelines for drinking water as they are both related to human health, but this can be explained by swimming (?). Finally, the trophic status classification of river that we used (Dodds 19XX) is based on nutrients concentration and chla, which is interesting as the effect of these compounds have an indirect effect on ecosystem, but are not generaly concidered as contamiant they have ecosystemic consequences. 

```{r guidelines table ,echo=F,include=F}
freq=apply(db_wide_ym,2,colFreq)

colFreq(db_wide_ym$fc)


guide.sub=guide[guide$Pollutant%in%colnames(db_wide_ym)&guide$Limit=="upper",]
guide.wide=spread(guide.sub[,c("Category","Chemical.groups","Pollutant","Concentration")],Category,Concentration)

guide.wide=guide.wide[order(guide.wide$Pollutant),]
guide.wide=guide.wide[order(guide.wide$Chemical.groups),]
freq=round(freq[guide.wide$Pollutant],2)
guide.wide=cbind(guide.wide,freq)
rownames(guide.wide)=guide.wide$Pollutant;guide.wide$Pollutant=NULL
guide.wide[is.na(guide.wide)]=""
guide.wide=t(guide.wide)
guide.wide=(guide.wide[-1,])

write.csv(guide.wide,file = "data/guide.wide.csv")
write.csv(limFreq[order(rownames(limFreq)),colnames(guide.wide)],file = "data/limFreq.csv")


rownames(guide.wide)=c("Aquatic Wildlife","Drinking","Irrigation","Livestock","Mesotrophic","Oligotrophic","Recreational","Frequency")

kable(guide.wide, "pandoc") %>%
  add_header_above(c(" ", "Biological" = 1, "Inorganic Chemicals" = 3,"Metals"=4, "Nutrients"=2, "Organic Chemical"=1,"Pesticides"=5)) %>%
  kable_styling(position="center",bootstrap_options = c("striped", "hover", "condensed"), full_width = F)%>%
  row_spec(0, angle = 0)


```

### 2.Compare ecoservices in the dataset

In this table, we compare the occurence of the different ecoservices in the dataset. On the diagonal of this table, the proportion of sites for which a given criteria was met is reported. Outside the diagonal we are reporting how often the column criteria is met when the row criteria is met. 

```{r inclusion matrix ,echo=F}


# This function uses the ES space DB to calculate the emperical overlap between ecosystem services in canadian rivers.
incMatrix=overlapES(sitesClass,rd=3)

# Export table
kable(incMatrix, "pandoc") %>%
  kable_styling(position="center",bootstrap_options = c("striped", "hover", "condensed"))

```

In this dataset, `r incMatrix["oligotrophic","oligotrophic"]*100` % of sites were oligotrophic, `r incMatrix["mesotrophic","mesotrophic"]*100` % mesotrophic and `r incMatrix["eutrophic","eutrophic"]*100`%  eutrophic. Only `r incMatrix["aquatic","aquatic"]*100`% of the samples were suitable for aquatic life, `r incMatrix["recreational","recreational"]*100`% for swimming and `r incMatrix["drink","drink"]*100`% for drinking. For gricultural use, in `r incMatrix["irrigation","irrigation"]*100`% of the samples the water was usable for irrigation and `r incMatrix["livestock","livestock"]*100`% for livestock. 

When the water is oligotrophic are more often suitable for aquatic life (`r incMatrix["oligotrophic","aquatic"]*100`%), recreation (`r incMatrix["oligotrophic","recreational"]*100`%), drinking (`r incMatrix["oligotrophic","drink"]*100`%) and irrigation (`r incMatrix["oligotrophic","irrigation"]*100`%) than mesotrpohic and eutrophic samples. 



First, no matter the trophic status of a river,in the data at hand, water was safe livestock more than `r incMatrix["oligotrophic","irrigation"]*100`%  of the time (See table S1).Similarly, In a large proportion of rivers, even when the water was eutrophic, the water could be used as drinking water (89%-94%) or irrigation water (90%-98%), while for recreation water is usually safe in oligotrophic and mesotrophic rivers (respectivly 93% and 82%) and this proportion drops drastically in eutrophic rivers (44%). However, even oligotrophic rivers could be considered safe for aqautic life only 55% of the time, while for mesotrophic and eutrophic rivers it was respectivly 43% and 34%. 

Even if, as we expected, for each use the % of suitable systems dropped with trophic status, the observed magnitudes were quite unexpected. First for drinking water, irrigation and recreation, as one would expect the propotion of suitable sample was high in oigotrophic rivers, but wasen't much lower for eutrophic system, in the sense that in the vast majority of rivers most services were still maintained. On limitation that is important to concider, it that we only used a subset of guidelines and that because of inconsistencies in data it wasen't possible to evaluate each guideline as a consequence it is possible that in reality the percentage of suitable samples was lower, but it is unlikly that our conclusions would be affected significantly. 

On the other hand, for the protection of aquatic wildlife, even if we expected eutrophic systems to be less safe for aquatic wildlife, it is quite surprising that even in oligotrophic rivers, only 55% percent of the sample, water was concidered as safe of aquatic life. Here again the pattern make sense but the magnitude is off. 



```{r radar plot  ,echo=F,include = FALSE}
library(colourpicker)
#plotHelper()
#col2rgb("#1DCF1D")/250
radar.dat=incMatrix[c("oligotrophic","mesotrophic","eutrophic"),c("aquatic","recreational", "drink", "irrigation", "livestock")]
radar.dat=as.data.frame(rbind(rep(1,ncol(radar.dat)) , rep(0.01,ncol(radar.dat)) , radar.dat))
colors_border=c( rgb(0.112,0.56,0.876,0.9), rgb(0.18,0.796,0.828,0.9) , rgb(0.204,0.64,0.176,0.9) )
colors_in=c( rgb(0.112,0.56,0.876,0.2), rgb(0.18,0.796,0.828,0.2) , rgb(0.204,0.64,0.176,0.2) )

radar<-function(){

radarchart( radar.dat  , axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.
)
legend(x=1, y=1.2, legend = rownames(radar.dat[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey32", cex=1.2, pt.cex=3)
}
#print(radar())


 
 ReporteRsWrap( radar,"radar")

#rad=readPNG("figures/radar.png",native=T,info=T)
#attr(rad,"info")


radar.dat=incMatrix[c("aquatic","recreational", "drink", "irrigation", "livestock"),c("aquatic","recreational", "drink", "irrigation", "livestock")]

radar.dat[c(1),c(1)]=0;radar.dat[c(2),c(2)]=0;radar.dat[c(3),c(3)]=0;radar.dat[c(4),c(4)]=0;radar.dat[c(5),c(5)]=0

colors_border=c( rgb(0.112,0.56,0.876,0.9), rgb(0.18,0.796,0.828,0.9) , rgb(0.204,0.64,0.176,0.9),rgb(0.116,0.828,0.116,0.9),rgb(0.908,0.104,0.112,0.9) )
colors_in=c( rgb(0.112,0.56,0.876,0.2), rgb(0.18,0.796,0.828,0.2) , rgb(0.204,0.64,0.176,0.2),rgb(0.116,0.828,0.116,0.2),rgb(0.908,0.104,0.112,0.2)  )

radar.dat=as.data.frame(rbind(rep(1,ncol(radar.dat)) , rep(0.01,ncol(radar.dat)) , radar.dat))
#radarchart( radar.dat  , axistype=1 , 
            #custom polygon
          #  pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
           # cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
           # vlcex=0.8
#)
#legend(x=1, y=1.2, legend = rownames(radar.dat[-c(1,2),]), bty = "n", pch=20 , col=colors_border , text.col = "grey32", cex=1.2, pt.cex=3)
```



![title](figures/radar_mod.png)
![title](figures/guidelines.png)




#### Ecoservices PCA
*** 

In the ecoservices PCA, the first and second axes are mainly trophic axes, on which, all ecoservices are more associated with oligotrophic water. On the third axis, we see a strong association between recreational and irrgations services, and between aquatic wildlife and drinking, but a negative association between the two groups. By looking at the ecoservices guideline table, it make sense that aquatic wildlife and drinking are associated, as their respectives guidelines are similar, but it isn't the case for irrigation and recreation. 
```{r services PCA,echo=F}
#![title](figures/guide.wide_lim.pdf)
spaceSel=c("oligotrophic","mesotrophic","aquatic","irrigation","recreational","drink","eutrophic","livestock")
sel=which(rowSums(is.na(sitesClass[,spaceSel])) == 0)
pca=prcomp(sitesClass[sel,spaceSel],center = T,scale. = T)

impo=(summary(pca)$importance)
# axes 1 and 2
plotPCA12<-function(){
axes=c(1,2)
m=1
sp=vegan::scores(pca,display = "species",choices=axes*m)
plot(vegan::scores(pca,display = "species"),type="n",xlim=range(sp[,1]*1.1),xlab=paste0("PC1 (",round(impo[2,axes[1]],2)*100,"%)"),ylab=paste0("PC2 (",round(impo[2,axes[2]],2)*100,"%)"))
text(sp,labels=rownames(sp),col="grey35")
arrows(0,0,sp[,1]*0.85,sp[,2]*0.85,length=0.07)
abline(h=0);abline(v=0)
}
plotPCA12()
  ReporteRsWrap(plotPCA12,"PCA12")

# axes 2 and 3
  plotPCA23<-function(){
axes=c(2,3)
m=1
sp=vegan::scores(pca,display = "species",choices=axes*m)
plot(vegan::scores(pca,display = "species"),type="n",xlim=range(sp[,1]*1.1),ylim=range(sp[,2]*1.1),xlab=paste0("PC1 (",round(impo[2,axes[1]],2)*100,"%)"),ylab=paste0("PC2 (",round(impo[2,axes[2]],2)*100,"%)"))
text(sp,labels=rownames(sp),col="grey35")
arrows(0,0,sp[,1]*0.85,sp[,2]*0.85,length=0.07)
abline(h=0);abline(v=0)
}
  plotPCA23()
  ReporteRsWrap(plotPCA23,"PCA23")


```


```{r map ,echo=F}

#plotMap<- function(){
world_map <- map_data("world", "Canada") 

#Creat a base plot with gpplot2
p <- ggplot() + coord_fixed() +
  xlab("") + ylab("")

cleanup <- 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = "transparent",colour = NA),
        plot.background = element_rect(fill = "transparent",colour = NA),
        axis.line = element_line(colour = "white"), legend.position="none",
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())

points<-
  geom_point(data=location, 
             aes(x=long, y=lat), colour="black", 
             fill="black",pch=21, size=1, alpha=I(0.6))

#Add map to base plot
base_world <- p + geom_polygon(data=world_map, aes(x=long, y=lat, group=group), 
                                     colour="light blue", fill="light blue")+ cleanup  +points
base_world

#}

plotMap<-function(){print(base_world)}

  ppi=600
  png("figures/mapCdn.png",width = 4, height = 5, units = 'in',bg="transparent",res=ppi)
  print(base_world)
  dev.off()

  #ReporteRsWrap(plotMap,"mapCDN")


```

#### Comparing the limiting guidelines
*** 

In this table we compare the limiting guidelines for each ecosystem services. For each guideline, how often when measured a specific compounds limiting a given use. This metric enable to identify compounds that are often limiting when measured which could mean that we overestimated of often a given use can be provided by a system. 

The compound that most often limited aquatic wildlife was cadmium concentration followed by lead and fluride, three compounds that were rarely limiting for other uses. For drinking, even if E.coli was measuredin only 9% on the samples, it limited drinking water 89% of the time, which could indicate that we probably overestimated the proportion of rivers in which water was potable. While arsenic and lead limited water use only in few samples. 

Similarly for irrigation and recreation, when E.coli was measured it limited suitability in respectivly 48% and 21% of the time which also indicate a potential overestimation. 

But for Irrigation Dicamba, a pesticide that was measured in less than 0.1% of samples, limited irrigation 100% of the time when measured, which indicate that we probably overestimate the sutability of cnadian water for irrigation (under detection limit need to be revised. 

 Interestingly, for the selected uses, dicamba was the only measured pesticide with a limitimg effect. 
For livestock, asenic was the only limiting contaminant, and was only limiting less 1% of the time. 



For trophic status, when a sample change from one trophic status to the other, TN and TP are almost always both over the guideline (Even if TP was measure more often)

# maybe we should calculate how often a variable is limiting when measured?

```{r compaare limiting,echo=F,results='asis'}
#limComp=round(critLim,2)
#limComp=limComp[order(rowSums(limComp,na.rm = T),decreasing = T),]

#limComp[is.nan(limComp)]=""

#for(i in 1:nrow(limComp)){
 # temp=t(limComp[i,,drop=F])
  #temp=temp[!is.na(temp),,drop=F]
 # temp=as.numeric(temp[,1])
 # temp=temp[order(temp[,1,drop=F],decreasing = T),,drop=F]
#print(kable(temp, "html",align=c(rep('c', 8))) %>%
  #kable_styling(bootstrap_options = c("striped", "hover", "condensed"),position = "center",full_width = F))
# }

```